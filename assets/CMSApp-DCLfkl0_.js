import{j as e,A as g}from"./main-B1cBy9UY.js";import{r as s}from"./state-DOKsaQ-a.js";import{F as D,a as E,S as F,X as L}from"./ui-BzbG-TcE.js";import{u as P}from"./index-BUTEixKY.js";import{u as $}from"./usePerformanceMonitor-CNitBdUJ.js";import"./vendor-CZvkgD4c.js";function I({files:t,onFileSelect:c,selectedFile:u,onLoadDirectory:h}){const[l,a]=s.useState({}),p=async r=>{const i=l[r.path]||{isOpen:!1,children:[],isLoaded:!1};if(i.isOpen){a(n=>({...n,[r.path]:{...i,isOpen:!1}}));return}if(i.isLoaded)a(n=>({...n,[r.path]:{...i,isOpen:!0}}));else{const n=await h(r.path);a(d=>({...d,[r.path]:{isOpen:!0,children:n,isLoaded:!0}}))}},v=(r,i=0)=>{const n=r.type==="dir",d=l[r.path],m=d?.isOpen||!1,y=u?.path===r.path;return n?e.jsxs("div",{children:[e.jsxs("div",{className:`dir-item ${m?"open":""}`,style:{paddingLeft:`${i*16+16}px`},onClick:()=>p(r),children:[e.jsx(D,{size:16}),r.name]}),m&&d.children.length>0&&e.jsx("div",{className:"dir-children",children:d.children.map(x=>v(x,i+1))})]},r.path):e.jsxs("div",{className:`file-item ${y?"active":""}`,style:{paddingLeft:`${i*16+16}px`},onClick:()=>c(r),children:[e.jsx(E,{size:16}),r.name]},r.path)};return e.jsx("div",{children:t.map(r=>v(r))})}function M({content:t,onChange:c,disabled:u,placeholder:h}){const l=s.useRef(null);return s.useEffect(()=>{t&&l.current&&l.current.focus()},[t]),e.jsxs("div",{className:"editor",children:[e.jsx("h3",{children:"Editor"}),e.jsx("textarea",{ref:l,id:"editor",value:t,onChange:a=>c(a.target.value),disabled:u,placeholder:h||"Select a file to edit..."})]})}function O(){const[t,c]=s.useState(""),[u,h]=s.useState(!1),[l,a]=s.useState(null),p=s.useRef(null),v=s.useRef(0),r=s.useRef(null);s.useEffect(()=>{const n=new Worker(new URL(""+new URL("markdown.worker-Dti5hhgv.js",import.meta.url).href,import.meta.url),{type:"module"});return n.onmessage=d=>{const{id:m,html:y,error:x}=d.data;if(m==="ready"){h(!0);return}r.current===m&&(x?a(x):(c(y),a(null)),r.current=null)},n.onerror=d=>{console.error("Markdown worker error:",d),a("Worker error occurred"),h(!1)},p.current=n,()=>{n.terminate()}},[]);const i=s.useCallback(n=>{if(!p.current||!u)return;const d=`request-${++v.current}`;r.current=d;const m={id:d,markdown:n};p.current.postMessage(m)},[u]);return{html:t,parse:i,isReady:u,error:l}}function T(t,c){const[u,h]=s.useState(t);return s.useEffect(()=>{const l=setTimeout(()=>{h(t)},c);return()=>{clearTimeout(l)}},[t,c]),u}function _({content:t,isMarkdown:c}){const{html:u,parse:h,isReady:l,error:a}=O(),p=T(t,300);return s.useEffect(()=>{c&&l&&p&&h(p)},[p,c,l,h]),c?a?e.jsxs("div",{className:"preview",children:[e.jsx("h3",{children:"Preview"}),e.jsx("div",{className:"preview-content",children:e.jsxs("div",{className:"empty-state",style:{color:"#ef4444"},children:["Error: ",a]})})]}):t?e.jsxs("div",{className:"preview",children:[e.jsx("h3",{children:"Preview"}),e.jsx("div",{className:"preview-content",dangerouslySetInnerHTML:{__html:u}})]}):e.jsxs("div",{className:"preview",children:[e.jsx("h3",{children:"Preview"}),e.jsx("div",{className:"preview-content",children:e.jsx("div",{className:"empty-state",children:"Preview will appear here for markdown files"})})]}):e.jsxs("div",{className:"preview",children:[e.jsx("h3",{children:"Preview"}),e.jsx("div",{className:"preview-content",children:e.jsx("div",{className:"empty-state",children:"Preview available for markdown files only"})})]})}function V(){const t=P(g.repository.owner,g.repository.name),{startTimer:c,endTimer:u}=$("cms"),[h,l]=s.useState([]),[a,p]=s.useState(null),[v,r]=s.useState(""),[i,n]=s.useState(!1),[d,m]=s.useState(!1),[y,x]=s.useState(!0),j=s.useCallback(o=>o.filter(f=>!f.name.startsWith(".")&&f.name!=="node_modules"),[]);s.useEffect(()=>{w()},[]);const w=async()=>{try{x(!0);const o=await t.listDirectory("");l(j(o))}catch(o){console.error("Error loading directory:",o),alert(`Error: ${o.message}`)}finally{x(!1)}},S=s.useCallback(async o=>{try{const f=await t.listDirectory(o);return j(f)}catch(f){return console.error("Error loading directory:",f),[]}},[t,j]),C=s.useCallback(async o=>{if(o.type!=="dir"&&!(i&&!confirm("You have unsaved changes. Discard them?")))try{const f=await t.getFile(o.path);p(f),r(f.content),n(!1)}catch(f){alert(`Error loading file: ${f.message}`)}},[t,i]),N=s.useCallback(o=>{r(o),n(!0)},[]),b=s.useCallback(async()=>{if(!(!a||!i)){m(!0);try{c("save_latency_ms");const o=`Update ${a.path.split("/").pop()}`;await t.updateFile(a.path,v,a.sha,o);const f=await t.getFile(a.path);u("save_latency_ms"),p(f),n(!1),alert("Saved successfully!")}catch(o){alert(`Error saving: ${o.message}`)}finally{m(!1)}}},[a,v,i,t,c,u]),k=()=>{i&&!confirm("You have unsaved changes. Close anyway?")||window.parent.postMessage("close-app","*")},R=a?.path.endsWith(".md")||!1;return e.jsxs("div",{style:{display:"flex",flexDirection:"column",height:"100vh"},children:[e.jsxs("div",{className:"header",children:[e.jsx("h2",{children:"Content Manager"}),e.jsxs("div",{style:{display:"flex",gap:"8px"},children:[e.jsxs("button",{className:"btn btn-success",onClick:b,disabled:!i||d,children:[e.jsx(F,{size:16}),d?"Saving...":"Save"]}),e.jsxs("button",{className:"btn",onClick:k,children:[e.jsx(L,{size:16}),"Close"]})]})]}),e.jsxs("div",{className:"main",children:[e.jsxs("div",{className:"sidebar",children:[e.jsx("div",{className:"sidebar-header",children:"Repository Files"}),y?e.jsx("div",{style:{padding:"20px",textAlign:"center",color:"#9ca3af"},children:"Loading..."}):e.jsx(I,{files:h,onFileSelect:C,selectedFile:a?{...a,type:"file"}:null,onLoadDirectory:S})]}),e.jsxs("div",{className:"editor-area",children:[e.jsx(M,{content:v,onChange:N,disabled:!a}),e.jsx(_,{content:v,isMarkdown:R})]})]})]})}export{V as default};
